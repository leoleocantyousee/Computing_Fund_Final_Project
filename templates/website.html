<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>LKR Library - Colorful Edition</title>

<style>
/* New Color Palette - We want this to look friendly and bright! */
body {
    font-family: Arial, sans-serif;
    background: #FFF7E0; /* Light Sandy Yellow background */
    padding: 20px;
}
.container {
    max-width: 900px;
    margin: 0 auto;
}
.card {
    background: #ffffff;
    padding: 18px;
    border-radius: 8px; 
    margin-bottom: 16px;
    border: 1px solid #FFD1A6; /* Light Peach Border */
    box-shadow: 0 4px 12px rgba(255,165,0,0.1); 
}
.header {
    background: #C0E8E8; /* Light Teal Header */
}
h1 {
    font-size: 1.8em;
    margin-bottom: 6px;
    color: #00796B; /* Dark Teal Text */
}
h3, h4, h5 { 
    color: #4CAF50; /* Friendly Green Headers */
}
label {
    font-weight: 600;
    color: #4CAF50; /* Green Labels */
}
input, select {
    width: 100%;
    padding: 10px;
    border: 1px solid #FFAB91; /* Coral Border */
    border-radius: 6px;
    box-sizing: border-box; 
}
button {
    padding: 10px 15px;
    border: none;
    background: #4CAF50; /* Vibrant Green Button */
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
}
button:hover {
    background: #388E3C; /* Darker Green on Hover */
}
.book-card {
    background: #E8F5E9; /* Very Light Green Card */
    padding: 15px;
    border: 1px solid #A5D6A7; /* Medium Green Border */
    border-radius: 6px;
    flex: 1 1 calc(33.33% - 10px); 
    min-width: 250px;
}
.message.success {
    background: #D4EDDA; /* Light Mint Green */
    color: #155724; /* Dark Forest Green Text */
    border: 1px solid #C3E6CB;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
}
.message.error {
    background: #F8D7DA; /* Light Pink/Red for errors */
    color: #721C24; /* Dark Maroon Text */
    border: 1px solid #F5C6CB;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
}
.hidden { display:none; }
.small { font-size:0.9em;color:#6C7A89; }
.book-grid { display:flex; flex-wrap:wrap; gap:15px; } 
.analytics-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
.analytic-stat { background: #F3E5F5; /* Light Purple Stat Box */
    padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #E1BEE7; }
.analytic-stat .value { font-size: 2.2em; font-weight: bold; color: #9C27B0; /* Deep Purple Value */ }
.analytic-stat .label { font-size: 0.9em; color: #7B1FA2; }
.overdue { color: red; font-weight: bold; }
</style>
</head>

<body>
<div class="container">

  <div class="card header">
    <h1>LKR Library System ðŸ“š</h1>
  </div>

  <div id="authSection" class="card">
    <h3>Login / Register</h3>
    <label>Username</label>
    <input id="authUsername">

    <label style="margin-top:6px;">Password</label>
    <input id="authPassword" type="password">

    <label style="margin-top:6px;">Email (Optional)</label>
    <input id="authEmail">

    <div style="margin-top:10px">
        <button onclick="login()">Login</button>
        <button onclick="register()" style="margin-left:8px;">Register</button>
        <button onclick="guest()" style="margin-left:8px;">Browse as Guest</button>
    </div>

    <div id="authMessage"></div>
  </div>

  <div id="mainApp" class="hidden">

    <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
        <strong id="currentUsername" style="color:#00796B;font-size:1.1em;"></strong>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="librarianDashboard" class="card hidden">
      <h4>Librarian Dashboard</h4>

      <div style="margin-bottom:10px;">
          <button onclick="showStats()" style="margin-right:8px">System Stats</button>
          <button onclick="showAnalytics()">Analytics Dashboard</button>
      </div>
      
      <div id="statsSection">
        <h5 style="margin-top:10px">System Overview</h5>
        <div>Total books: <span id="statTotalBooks">0</span></div>
        <div>Active checkouts: <span id="statActiveCheckouts">0</span></div>
        <div class="overdue">Overdue: <span id="statOverdue">0</span></div>
        <div>Total Registered Users: <span id="statTotalUsers">0</span></div>
      </div>
      
      <div id="analyticsSection" class="hidden">
        <h5 style="margin-top:10px">Analytics Dashboard</h5>
        
        <div class="analytics-grid">
            <div class="analytic-stat">
                <div class="value" id="analyticActiveUsers">0</div>
                <div class="label">Users Currently Borrowing</div>
            </div>
            <div class="analytic-stat">
                <div class="value" id="analyticTotalFines">$0.00</div>
                <div class="label">Total Fines Collected</div>
            </div>
        </div>

        <h5 style="margin-top:10px">Most Borrowed Books (Top 5)</h5>
        <div id="mostBorrowedList">Loading...</div>
      </div>


      <h4 style="margin-top:15px">Add New Book</h4>

      <input id="newBookTitle" placeholder="Title">
      <input id="newBookAuthor" placeholder="Author" style="margin-top:6px">
      <input id="newBookISBN" placeholder="ISBN (optional)" style="margin-top:6px">
      <input id="newBookCopies" type="number" value="1" style="margin-top:6px" min="1">

      <button onclick="addBook()" style="margin-top:6px">Add Book to Library</button>

      <div id="addBookMessage"></div>
    </div>

    <div class="card">
      <h4>Available Books</h4>
      <div id="booksGrid" class="book-grid"></div>
    </div>

    <div id="myCheckoutsSection" class="card hidden">
      <h4>My Checkouts</h4>
      <div id="myCheckoutsGrid" class="book-grid"></div>
    </div>

    <div id="actionMessage"></div>
  </div>

</div>

<script>
let currentUser=null, currentRole=null;

// A helper function for showing messages at the top of a section
function showMessage(id,msg,err=false){
  const el=document.getElementById(id);
  el.innerHTML='<div class="message '+(err?'error':'success')+'">'+msg+'</div>';
  setTimeout(()=>{el.innerHTML=''},4000);
}

// Handles user login
async function login(){
  const u=document.getElementById('authUsername').value;
  const p=document.getElementById('authPassword').value;

  const r=await fetch('/api/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:u,password:p})
  });

  const d=await r.json();
  if(d.success){
    currentUser=u;
    currentRole=d.role;
    showMain();
  } else {
    showMessage('authMessage',d.message,true);
  }
}

// Handles user registration
async function register(){
  const u=document.getElementById('authUsername').value;
  const p=document.getElementById('authPassword').value;
  const e=document.getElementById('authEmail').value;

  const r=await fetch('/api/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:u,password:p,email:e})
  });

  const d=await r.json();
  showMessage('authMessage',d.success?'Registered! Please login now.':d.message,!d.success);
}

// Allows browsing without logging in
function guest(){
  currentUser=null;
  currentRole='guest';
  document.getElementById('myCheckoutsSection').classList.add('hidden'); 
  showMain();
}

// Logs the user out and returns to the auth screen
function logout(){
  currentUser=null;
  currentRole=null;
  document.getElementById('authSection').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
}

// Shows the main book/dashboard view based on user role
function showMain(){
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('currentUsername').textContent='Logged in as: '+(currentUser||'Guest');

  if(currentRole==='librarian'){
    document.getElementById('librarianDashboard').classList.remove('hidden');
    document.getElementById('myCheckoutsSection').classList.add('hidden');
    showStats(); 
  } else if (currentRole === 'user') {
    document.getElementById('librarianDashboard').classList.add('hidden');
    document.getElementById('myCheckoutsSection').classList.remove('hidden');
    loadMyCheckouts();
  } else {
     // Guest view
     document.getElementById('librarianDashboard').classList.add('hidden');
     document.getElementById('myCheckoutsSection').classList.add('hidden');
  }

  loadBooks();
}

// Switches the librarian view to show system stats
function showStats() {
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('analyticsSection').classList.add('hidden');
    loadStats();
}

// Switches the librarian view to show analytics
function showAnalytics() {
    document.getElementById('statsSection').classList.add('hidden');
    document.getElementById('analyticsSection').classList.remove('hidden');
    loadAnalytics();
}

// Fetches and displays all available books
async function loadBooks(){
  const r=await fetch('/api/books');
  const books=await r.json();
  const grid=document.getElementById('booksGrid');
  grid.innerHTML='';

  books.forEach(b=>{
    const card=document.createElement('div');
    card.className='book-card';

    card.innerHTML = `
      <b>${b.title}</b>
      <div class="small">by ${b.author}</div>
      <div style="margin-top:5px;">Available: <strong>${b.available_copies}</strong></div>
    `;

    if(currentRole==='user'){
      const btn=document.createElement('button');
      btn.textContent='Checkout';
      btn.style.marginTop='8px';
      btn.disabled = b.available_copies <= 0;
      if (b.available_copies <= 0) {
        btn.textContent = 'Out of Stock';
        btn.style.backgroundColor = '#FFAB91';
        btn.style.cursor = 'not-allowed';
      }
      btn.onclick=()=>checkoutBook(b.id);
      card.appendChild(btn);
    }

    grid.appendChild(card);
  });
}

// Sends a request to the backend to checkout a book
async function checkoutBook(id){
  if(!currentUser) {
      showMessage('actionMessage', 'Error: Please log in to checkout a book.', true);
      return;
  }
  
  const r=await fetch('/api/checkout',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({book_id:id})
  });

  const d=await r.json();

  if(d.success){
    showMessage('actionMessage','Success! Checked out! Due: '+d.due_date);
  } else {
    showMessage('actionMessage','Error: '+d.message,true);
  }

  loadBooks();
  loadMyCheckouts();
}

// Sends a request to the backend to return a book
async function returnBook(id){
  const r=await fetch('/api/return',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({book_id:id})
  });

  const d=await r.json();

  if(d.success){
    let msg = 'Success! Book Returned.';
    if (d.fine > 0) {
        msg += ' You paid a fine of $'+d.fine.toFixed(2)+'.';
    }
    showMessage('actionMessage',msg);
  } else {
    showMessage('actionMessage','Error: '+d.message,true);
  }

  loadBooks();
  loadMyCheckouts();
  if (currentRole === 'librarian') loadAnalytics();
}

// Fetches and displays the user's currently borrowed books
async function loadMyCheckouts(){
  if(!currentUser || currentRole !== 'user') return;
  
  const r=await fetch('/api/my_checkouts');
  const list=await r.json();
  const grid=document.getElementById('myCheckoutsGrid');
  grid.innerHTML='';

  if (list.length === 0) {
    grid.innerHTML = '<div style="margin-left:5px;">You have no active checkouts.</div>';
    return;
  }

  list.forEach(c=>{
    const card=document.createElement('div');
    card.className='book-card';
    
    // Highlight if the book is overdue
    let dueDateMsg = `Due: ${c.due_date}`;
    if (c.is_overdue) {
        dueDateMsg = `<span class="overdue">OVERDUE!</span> (${c.due_date})`;
    }

    card.innerHTML = `
      <b>${c.book.title}</b>
      <div class="small">by ${c.book.author}</div>
      <div style="margin-top:5px;">${dueDateMsg}</div>
      <button onclick="returnBook(${c.book_id})" style="margin-top:8px;">Return Book</button>
    `;
    grid.appendChild(card);
  });
}

// Librarian function to add a new book
async function addBook(){
  const title=document.getElementById('newBookTitle').value;
  const author=document.getElementById('newBookAuthor').value;
  const isbn=document.getElementById('newBookISBN').value;
  const copies=document.getElementById('newBookCopies').value;
  
  if(!title || !author || !copies){
      showMessage('addBookMessage','Error: Title, Author, and Copies are required.',true);
      return;
  }

  const r=await fetch('/api/add_book',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({title,author,isbn,copies})
  });

  const d=await r.json();
  showMessage('addBookMessage',d.success?'Added book: '+title:'Error: '+d.message,!d.success);
  loadBooks();
  loadStats();
}

// Librarian function to fetch and display simple stats
async function loadStats(){
  if(currentRole !== 'librarian') return;

  const r=await fetch('/api/stats');
  const d=await r.json();

  document.getElementById('statTotalBooks').textContent=d.total_books;
  document.getElementById('statActiveCheckouts').textContent=d.active_checkouts;
  document.getElementById('statOverdue').textContent=d.overdue;
  document.getElementById('statTotalUsers').textContent=d.total_users;
}

// Librarian function to fetch and display analytics data
async function loadAnalytics(){
  if(currentRole !== 'librarian') return;

  const r=await fetch('/api/analytics');
  const d=await r.json();

  // 1. Update simple stats
  document.getElementById('analyticActiveUsers').textContent=d.active_user_count || 0;
  document.getElementById('analyticTotalFines').textContent='$'+(d.total_fines ? d.total_fines.toFixed(2) : '0.00');

  // 2. Populate Most Borrowed List
  const listEl=document.getElementById('mostBorrowedList');
  listEl.innerHTML=''; 

  if (d.most_borrowed && d.most_borrowed.length > 0) {
    const ul = document.createElement('ul');
    d.most_borrowed.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.title} (Borrowed ${item.times} times)`;
        ul.appendChild(li);
    });
    listEl.appendChild(ul);
  } else {
     listEl.textContent = 'No books have been borrowed yet.';
  }
}

</script>
</body>
</html>